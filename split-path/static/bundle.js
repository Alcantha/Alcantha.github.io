!function(){var t=class{constructor({elementId:t}){this._element=document.getElementById(t)}setText(t){this._element.innerText=t}setTitle(t){this._element.title=t}},s=class extends t{constructor(t){super(t),this._callbacksOnClick=[],this._initEventListeners()}_initEventListeners(){this._element.addEventListener("click",this._eventClick.bind(this))}_eventClick(){this._callbacksOnClick.forEach(t=>t())}setDisabled(t){this._element.disabled=t}onClick(t){this._callbacksOnClick.push(t)}},n=t;function r(t){const e=Number.parseInt(t);return Number.isNaN(e)?null:e}var i={MAX_BOUNDARY:Symbol("maxBoundary"),MIN_BOUNDARY:Symbol("minBoundary"),ADD_OPERATOR:Symbol("+"),SUB_OPERATOR:Symbol("-"),MUL_OPERATOR:Symbol("*"),DIV_OPERATOR:Symbol("/"),MOD_OPERATOR:Symbol("%"),constant:function(t){return()=>t},clamp:function(t,e,s){return t<e?e:t>s?s:t},parseInteger:r,parseIntegerList:function(t){const e=t?t.trim():"";if(0===e.length)return[];let s=!0;const n=[];for(const i of e.split(/\s+/)){const t=r(i);if(null===t){s=!1;break}n.push(t)}return s?n:null},parseText:function(t){return void 0!==t?t.trim():""},getGridSize:function(t,e,s){return Number.parseInt((t-2*e-1)/s+1)},getGridOffset:function(t){return Number.parseInt((t-1)/2)},getCanvasOffset:function(t,e,s){return Number.parseInt((t-(s-1)*e-1)/2)}};const{parseInteger:a}=i;var o=class extends t{constructor({elementId:t,defaultValue:e}){super({elementId:t}),this._callbacksOnChange=[],this._initEventListeners(),this._defaultValue=e,this._currentValue=this.getValue()}_initEventListeners(){this._element.addEventListener("change",this._eventChange.bind(this))}clearValue(){this._element.value=""}appendText(t){this._element.value+=t}getRawValue(){return this._element.value}getValue(){return this._element.value.trim()}getTextValue(){const t=this.getValue();return""!==t?t:this._defaultValue}getIntValue(){const t=a(this.getValue());return null!==t?t:this._defaultValue}setValue(t){this._element.value=t,this._currentValue=t}restoreDefaultValue(){this.setValue(this._defaultValue)}_eventChange(t){this._callbacksOnChange.forEach(e=>e(t))}onChange(t){this._callbacksOnChange.push(t)}};const{clamp:l,parseInteger:h}=i;var c=class extends o{constructor({elementId:t,defaultValue:e,minValue:s,maxValue:n,numberRequired:r=!0}){super({elementId:t,defaultValue:e}),this._minValue=s,this._maxValue=n,this._element.min=s,this._element.max=n,this._numberRequired=!0===r||r}_initEventListeners(){this._element.addEventListener("change",()=>{this._eventChange(this._callbacksOnChange)})}_eventChange(t){const e=this.getValue();let s=!0;const n=h(e);null!==n?this.setValue(l(n,this._minValue,this._maxValue)):(this._numberRequired||""!==e)&&(s=!1,this.setValue(this._currentValue)),s&&t.forEach(t=>t(e))}},u=class extends c{constructor({elementId:t,defaultValue:e,minValue:s=1,maxValue:n=100,stepValue:r=1}){super({elementId:t,defaultValue:e,minValue:s,maxValue:n}),this._stepValue=r,this._element.step=r,this._callbacksOnInput=[]}_initEventListeners(){super._initEventListeners(),this._element.addEventListener("input",()=>{this._eventChange(this._callbacksOnInput)})}_eventInput(t){this._callbacksOnChange.forEach(t=>t(e))}onInput(t){this._callbacksOnInput.push(t)}},d=t,_=class extends o{constructor({elementId:t,defaultValue:e}){super({elementId:t,defaultValue:e})}getBoolValue(){return this._element.checked}setValue(t){this._element.checked=t,this._currentValue=t}},p=class extends o{constructor({elementId:t,defaultValue:e}){super({elementId:t,defaultValue:e})}};const{getGridSize:g}=i;var m=class extends p{constructor({elementId:t}){super({elementId:t,defaultValue:""})}};const{parseInteger:f,parseIntegerList:E,parseText:S}=i,P=/\s+/,v="#[0-9a-f]{3,4}|#[0-9a-f]{6}|[a-zA-Z_](?:[\\w_]*)",C=new RegExp("^(-?\\s*\\d+)$"),x=new RegExp(`^(${v})$`,"i");function I(t){return t?t.trim():""}var b={PROPERTY_SEP:",",WHITESPACE_SEP:P,COLOR_COMMAND:"color",PATH_COMMAND:"path",START_PATH_COMMAND:"start",COMMENT_PATTERN:"(?://.*)?",PROPERTY_ASSIGN_PATTERN:"=",OPERATOR_PATTERN:"[^\\w\\s]+",INTEGER_PATTERN:"-?\\s*\\d+",WORD_PATTERN:"[a-zA-Z_](?:[\\w_]*)",COLOR_PATTERN:v,INTEGER_REGEX:C,BEGIN_NUMBER_REGEX:/^\d/,BOTTOM_POSITION:["b","bottom"],LEFT_POSITION:["l","left"],RIGHT_POSITION:["r","right"],TOP_POSITION:["t","top"],CARDINAL_AND_ORDINAL_DIRECTIONS:["e","se","s","sw","w","nw","n","ne"],TOKENS:{MIRROR:{prop:"mirror",regex:/m/i,process:()=>!0,optional:!0},COLOR:{prop:"color",regex:x,process:t=>t,optional:!0}},PATH_PROPERTIES:{max:{name:"maxCycle",parseValue:f,validator:t=>t>=0},color:{name:"color",parseValue:S,validator:t=>x.test(t)}},STEP_CONDITION_PROPERTIES:{after:{parseValue:f,validator:t=>t>=0},before:{parseValue:f,validator:t=>t>=2},every:{parseValue:E,validator:t=>!(t.length<=0)&&t.every(t=>t>=1)},only:{parseValue:E,validator:t=>!(t.length<=0)&&t.every(t=>t>=1)},start:{parseValue:f,validator:t=>t>=1}},START_PATH_PROPERTIES:{max:{name:"maxCycle",parseValue:f,validator:t=>t>=0},offset:{name:"offsetCycle",parseValue:f},startpoint:{name:"includeStartPoint",parseValue:f},color:{name:"color",parseValue:S,validator:t=>x.test(t)}},cleanText:I,splitText:function(t,{sep:e=P}={}){const s=I(t);return 0===s.length?[]:s.split(e)}};const{WHITESPACE_SEP:T,cleanText:y}=b;var R=class{constructor(t="",{optional:e=!1}={}){this._subParsers={},this._name=t,this._optional=e}init(){this._errors=[],this._warnings=[],this._subsForEach(t=>t.init())}addSubParser(t,e){this._subParsers[t]=e}getRegex(){return null}parse(t,e){if(this._optional&&void 0===t)return this._getDefaultValue();const s=this._preParse(t,e);return null===s?null:this._runParse(s,e)}_getDefaultValue(){}_preParse(t,e){const s=y(t);if(0===s.length)return this._addEmptyContentError(e),null;const n=this.getRegex();if(null===n)return[s];const r=n.exec(s);return null===r?(this._addCannotParseError(s,e),null):r}_runParse(){return null}parseList(t,e,s){const n=this._preParseList(t,e);return 0===n.length?[]:this._runParseList(n,e,s)}_preParseList(t,e){const s=y(t);return 0===s.length?"":s}_runParseList(t,e,{sep:s=","}={}){return this._parseArray(t.split(s),this.parse.bind(this),[],(t,e)=>t.push(e),e)}_parseArray(t,e,s,n,r){const i=s;let a=!0;const o=t.length;for(let l=0;l<o;l++){const s=e(t[l],r);null!==s?n(i,s):a=!1}return a?i:null}runParseTokens([t],e,s){const n={},r=function(t){const e=t.split(T),s=[];return e.forEach(t=>{if(s.length>0){const e=s.length-1;"-"===s[e]?s[e]+=t:s.push(t)}else s.push(t)}),s}(t);let i=0,a=!1,o=0;const l=r.length;for(;o<l&&!a;){const t=r[o];let l=!1;if(i>=s.length){a=!0,this._addError("unused value: "+r.slice(o).join(", "),e);break}for(;!l&&i<s.length;){const r=s[i];if(void 0===r.regex||r.regex.test(t)){const s=r.process(t);if(null===s){a=!0,r.addMessageError(this,e,t);break}void 0!==s&&(n[r.prop]=s),l=!0}else if(!r.optional){a=!0,r.addMessageError(this,e,t);break}++i}++o}return a?null:n}hasError(){return this._errors.length>0||this._subsSome(t=>t.hasError())}hasWarning(){return this._warnings.length>0||this._subsSome(t=>t.hasWarning())}getErrors(){return[...this._subsFlatMap(t=>t.getErrors()),...this._errors]}getWarnings(){return[...this._subsFlatMap(t=>t.getWarnings()),...this._warnings]}_subsFlatMap(t){return Object.values(this._subParsers).flatMap(t)}_subsForEach(t){Object.values(this._subParsers).forEach(t)}_subsSome(t){return Object.values(this._subParsers).some(t)}getErrorMessages(){return this.getErrors().join("\n")}getWarningMessages(){return this.getWarnings().join("\n")}_addError(t,e){const s=[t];e&&s.unshift(`L${e}.`),this._errors.push(s.join(" "))}_addEmptyContentError(t){this._addError(this._name+" is empty",t)}_addCannotParseError(t,e){this._addError(`cannot parse ${this._name}: ${t}`,e)}_addInvalidContentError(t,e,{name:s}={}){const n=s||this._name;this._addError(`invalid ${n}: ${t}`,e)}_addInvalidFieldError(t,e,s,n){const r=t?" "+t:"";this._addError(`${this._name}${r}: invalid ${e}: ${s}`,n)}_addWarning(t){this._warnings.push(t)}};const{COLOR_COMMAND:O,COMMENT_PATTERN:w,BEGIN_NUMBER_REGEX:N,splitText:V}=b,A=new RegExp(`^${O}\\s+([\\w\\s_]+?)\\s*(?:=\\s*(.+?))?${w}$`,"i");var M=class extends R{constructor({colorValidator:t}={}){super("color alias"),this._colorValidator=t}getRegex(){return A}_runParse([,t,e],s){const n=V(t);let r,i=!0,a=!0;if(0===n.length)this._addError("color names is missing",s);else{const t=n.filter(t=>N.test(t));t.length&&(i=!1,this._addError("color name cannot start by a number: "+t.join(", "),s))}if(e)if(r=V(e),0===r.length)this._addError("color values is missing",s);else{const{_colorValidator:t}=this;for(let e=0;e<r.length;++e){const n=r[e];null==t||t(n)||(a=!1,this._addInvalidContentError(n,s,{name:"color"}))}}if(null===n||null===r||!i||!a)return null;const o={names:n};return r&&(o.colors=r),o}};const{PROPERTY_ASSIGN_PATTERN:D,WORD_PATTERN:L,cleanText:k}=b,G=new RegExp(`^(${L})\\s*${D}\\s*(.+)$`);var F=class extends R{constructor(t,e){super(t+" property"),this._validProperties=e}getRegex(){return G}_runParse([,t,e],s){const n=k(t).toLowerCase(),r=this._validProperties[n];if(void 0===r)return this._addInvalidContentError(n,s),null;const i=r.parseValue(e);return null===i?(this._addInvalidFieldError(n,"format",e.trim(),s),null):r.validator&&!r.validator(i)?(this._addInvalidFieldError(n,"value",i,s),null):{name:void 0!==r.name?r.name:n,value:i}}};const{PROPERTY_SEP:$}=b;var W=class extends R{constructor(t,e){super(t+" properties",{optional:!0}),this.addSubParser("property",new F(t,e))}_runParse([t],e){return this._parseArray(t.split($),this._subParsers.property.parse.bind(this._subParsers.property),{},(t,{name:e,value:s})=>t[e]=s,e)}};const{COMMENT_PATTERN:B,COLOR_PATTERN:U,STEP_CONDITION_PROPERTIES:j,cleanText:H}=b,Y=new RegExp(`^(${U})(?::(.+?))?${B}$`);var X=class extends R{constructor({colorValidator:t}){super("next color"),this.addSubParser("nextColorConditions",new W("condition",j)),this._colorValidator=t}getRegex(){return Y}_runParse([,t,e],s){const{_colorValidator:n}=this,r=H(t);if(void 0!==n&&!n(r))return this._addInvalidContentError(r,s,{name:"color"}),null;const i=this._subParsers.nextColorConditions.parse(e,s);if(null===i)return null;const a={color:r};return i&&(a.conditions=i),a}};const{WORD_PATTERN:z,INTEGER_REGEX:q,TOKENS:K}=b,{parseInteger:Z}=i,J="_|"+z,Q=[K.MIRROR,{prop:"turn",regex:q,process:t=>Z(t),addMessageError(t,e,s){t._addInvalidFieldError("turn","value",s,e)}},{prop:"pathName",regex:new RegExp(`^(${J})$`,"i"),process:t=>"_"!==t?t:void 0,optional:!0},K.COLOR,{prop:"offset",regex:q,process(t){const e=Z(t);return null!==e?0!==e?e:void 0:null},addMessageError(t,e,s){t._addInvalidFieldError("offset","value",s,e)},optional:!0}];var tt=class extends R{constructor(){super("next step")}_runParse(t,e){return this.runParseTokens(t,e,Q)}};const{COMMENT_PATTERN:et,STEP_CONDITION_PROPERTIES:st}=b,nt=new RegExp(`^(.+?)(?::(.+?))?${et}$`);var rt=class extends R{constructor(){super("next step"),this.addSubParser("nextStepDirection",new tt),this.addSubParser("nextStepConditions",new W("condition",st))}getRegex(){return nt}_runParse([,t,e],s){const n=this._subParsers.nextStepDirection.parseList(t,s),r=this._subParsers.nextStepConditions.parse(e,s);if(null===n||null===r)return null;const i={directions:n};return r&&(i.conditions=r),i}};const{PATH_COMMAND:it,COMMENT_PATTERN:at,BEGIN_NUMBER_REGEX:ot,PATH_PROPERTIES:lt,splitText:ht}=b,ct=new RegExp(`^\\s*${it}(.+?)(?::(.+))?${at}$`,"i");var ut=class extends R{constructor(){super("path name"),this.addSubParser("properties",new W("path",lt))}getRegex(){return ct}_runParse([,t,e],s){const n=ht(t),r=this._subParsers.properties.parse(e);let i=!0;const a=n.filter(t=>ot.test(t));if(a.length&&(i=!1,this._addError("path name cannot start by a number: "+a.join(", "),s)),null===n||null===r||!i)return null;const o={names:n};return r&&(o.props=r),o}};const{OPERATOR_PATTERN:dt,INTEGER_PATTERN:_t,WORD_PATTERN:pt,cleanText:gt}=b,{MAX_BOUNDARY:mt,MIN_BOUNDARY:ft,ADD_OPERATOR:Et,SUB_OPERATOR:St,MUL_OPERATOR:Pt,DIV_OPERATOR:vt,MOD_OPERATOR:Ct,parseInteger:xt}=i,It=`${_t}|${pt}`,bt=new RegExp(`(${It})\\s*(${dt})\\s*(${It})`,"i");var Tt=class extends R{constructor(t,e,s){super(t),this._minKeywords=e,this._maxKeywords=s}_runParse([t],e){const s=gt(t);let n=this._parseSimpleExpression(s,e);return null===n?null:(void 0===n&&(n=this._parseValue(s,e)),n)}_parseSimpleExpression(t,e){const s=bt.exec(t);if(null===s)return;const[,n,r,i]=s,a=this._parseValue(n,e,!0),o=this._parseValue(i,e,!0),l=this._parseOperator(r,e);return null===a||null===o||null===l?null:{a:a,op:l,b:o}}_parseValue(t,e,s){let n;if(t=gt(t).toLowerCase(),this._minKeywords.includes(t))n=ft;else if(this._maxKeywords.includes(t))n=mt;else if(n=xt(t),null===n)return s?this._addInvalidFieldError(null,"value",t,e):this._addInvalidContentError(t,e),null;return n}_parseOperator(t,e){const s=gt(t);switch(s){case"+":return Et;case"-":return St;case"*":return Pt;case"/":return vt;case"%":return Ct;default:return this._addInvalidFieldError(null,"operator",s,e),null}}};const{BOTTOM_POSITION:yt,LEFT_POSITION:Rt,RIGHT_POSITION:Ot,TOP_POSITION:wt}=b,Nt=new RegExp("^\\((.+),(.+)\\)$","i");var Vt=class extends R{constructor(){super("position"),this._boundary=null,this.addSubParser("x",new Tt("position x",Rt,Ot)),this.addSubParser("y",new Tt("position y",wt,yt))}getRegex(){return Nt}_runParse([,t,e],s){const n=this._subParsers.x.parse(t,s),r=this._subParsers.y.parse(e,s);return null===n||null===r?null:{x:n,y:r}}};const{INTEGER_PATTERN:At,WORD_PATTERN:Mt,COLOR_PATTERN:Dt,INTEGER_REGEX:Lt,CARDINAL_AND_ORDINAL_DIRECTIONS:kt,TOKENS:Gt}=b,{parseInteger:Ft}=i,$t=new RegExp(`(?:(m)\\s+)?(${At}|${Mt})(?:\\s+(${Dt}))?(?:\\s+${At})?`,"i"),Wt=[Gt.MIRROR,{prop:"indexDirection",process(t){let e=Ft(t);if(null===e){const s=kt.indexOf(t.toLowerCase());e=-1!==s?s:null}return e},addMessageError(t,e,s){t._addInvalidContentError(s,e,{name:"direction"})}},Gt.COLOR,{prop:"offsetCycle",regex:Lt,process(t){const e=Ft(t);return null!==e?0!==e?e:void 0:null},addMessageError(t,e,s){t._addInvalidFieldError("offset","value",s,e)},optional:!0}];var Bt=class extends R{constructor(){super("start path")}getRegex(){return $t}_runParse(t,e){return this.runParseTokens(t,e,Wt)}};const{COMMENT_PATTERN:Ut,WORD_PATTERN:jt,START_PATH_PROPERTIES:Ht}=b,{parseText:Yt}=i,Xt=new RegExp(`^([^:]+):(${jt}):(.+?)(?::(.+))?\\s*${Ut}$`);var zt=class extends R{constructor(){super("start path"),this.addSubParser("position",new Vt),this.addSubParser("directions",new Bt),this.addSubParser("properties",new W("properties",Ht))}getRegex(){return Xt}_runParse([,t,e,s,n],r){const i=this._subParsers.position.parse(t,r),a=Yt(e),o=this._subParsers.directions.parseList(s,r),l=this._subParsers.properties.parse(n);if(null!=o&&0===o.length)return this._addError("start path: path is missing",r),null;if(null===i||null===o||null===l)return null;const h={startPos:i,paths:o.map(t=>(t.name=a,t))};return l&&(h.props=l),h}};const{START_PATH_COMMAND:qt,COMMENT_PATTERN:Kt,cleanText:Zt}=b,Jt=Symbol("none"),Qt=Symbol("color"),te=Symbol("path"),ee=Symbol("start"),se=new RegExp(`^\\s*${Kt}$`),ne=new RegExp(`^\\s*${qt}\\s*${Kt}$`,"i");var re=class extends R{constructor({colorValidator:t}={}){super("script"),this.addSubParser("colorName",new M({colorValidator:t})),this.addSubParser("nextColor",new X({colorValidator:t})),this.addSubParser("pathName",new ut),this.addSubParser("nextStep",new rt),this.addSubParser("startPath",new zt),this._regexesAndParsers=[{regex:se,parseLine:()=>{}},{regex:this._subParsers.pathName.getRegex(),parseLine:this._parsePathName.bind(this)},{regex:ne,parseLine:this._parseStartLabel.bind(this)},{regex:this._subParsers.colorName.getRegex(),parseLine:this._parseColorName.bind(this)},{regex:this._subParsers.nextColor.getRegex(),parseLine:this._parseNextColor.bind(this),state:Qt},{regex:this._subParsers.nextStep.getRegex(),parseLine:this._parseNextStep.bind(this),state:te},{regex:this._subParsers.startPath.getRegex(),parseLine:this._parseStartPath.bind(this),state:ee}]}init(){super.init(),this._data={colors:{},paths:{},startPaths:[]},this._currentColor=null,this._currentPath=null,this._state=Jt}getRegex(){return null}_runParse([t]){let e=!0;const s=Zt(t).split(/\n/);let n=!1;return s.map((t,e)=>[t.trim(),e+1]).filter(([t])=>t.length>0).map(([t,s])=>{n=!1;for(const{regex:r,parseLine:i,state:a}of this._regexesAndParsers){const o=r.test(t);if(o&&o&&(void 0===a||a===this._state)){n=!0,e=i(t,s)&&e;break}}n||(e=!1,this._addError("cannot parse: "+t,s))}),this._checkPathNames(),e?this.getResult():null}_parseColorName(t,e){const s=this._subParsers.colorName.parse(t,e);return null!==s&&(this._createColor(s),this._state=Qt,!0)}_createColor({names:t,colors:e}){this._currentColor={},Array.isArray(e)&&(this._currentColor.list=e);for(const s of t)this._data.colors[s]=this._currentColor}_parseNextColor(t,e){const s=this._subParsers.nextColor.parse(t,e);if(null===s)return!1;this._currentColor.next||(this._currentColor.next=[]),this._currentColor.next.push(s)}_parsePathName(t,e){const s=this._subParsers.pathName.parse(t);if(null===s)return!1;const{names:n,props:r}=s;return null!==this._currentPath&&this._checkPathNames(n),this._createPath(n,r),!0}_checkPathNames(t){if(t)for(const e of t)void 0!==this._data.paths[e]&&this._addWarning("overwritting path: "+e)}_createPath(t,e){this._currentPath={nextSteps:[]},e&&(this._currentPath.props=e);for(const s of t)this._data.paths[s]=this._currentPath;this._state=te}_parseNextStep(t,e){if(null===this._currentPath)return this._addWarning("cannot add next step to no path: "+line),!0;const s=this._subParsers.nextStep.parse(t,e);return null!==s&&(this._currentPath.nextSteps.push(s),!0)}_parseStartLabel(){return this._state=ee,!0}_parseStartPath(t,e){const s=this._subParsers.startPath.parse(t,e);return null!==s&&(this._data.startPaths.push(s),!0)}getResult(){return this._data}};class ie{constructor(t,e){this.x=t,this.y=e}add(t){return new ie(this.x+t.x,this.y+t.y)}sub(t){return new ie(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}toString(){const{x:t,y:e}=this;return`${t},${e}`}}var ae=ie;var oe={Vector2_ZERO:new ae(0,0)};const{Vector2_ZERO:le}=oe,he=Number.MAX_SAFE_INTEGER,ce=(Number.MAX_SAFE_INTEGER,[new ae(1,0),new ae(1,1),new ae(0,1),new ae(-1,1),new ae(-1,0),new ae(-1,-1),new ae(0,-1),new ae(1,-1)]);function ue(t){return 7&t}ce[-1]=le;const de={after:(t,e)=>t>e,before:(t,e)=>t<e,every:(t,e,{start:s=0})=>e.some(e=>(t-s)%e==0),only:(t,e)=>e.some(e=>e===t),start:(t,e)=>t>=e};var _e={STEP_BY_STEP_RUN_TYPE:"stepByStep",ANIMATED_RUN_TYPE:"animated",INSTANT_RUN_TYPE:"instant",MAX_ITERATION:he,INITIAL_SELF_CYCLE:0,DEFAULT_INCLUDE_START_POINT:1,DEFAULT_COLOR:"black",NO_INDEX_DIRECTION:-1,DIRECTIONS:ce,isCardinalDirection:function(t){return t%2==0},clampIndexDirection:ue,createInitialStep:function(t,e,s,n,r,i,a){const o=ce[ue(s)],l={name:t,pos:{begin:e,end:e.add(o)},indexDirection:s,cycle:{global:1,self:0,max:a,offset:i,colorOffset:0}};return n&&(l.mirror=n),r&&(l.color=r),l},createStep:function(t,e,s,n,r,i,a,o=0,l,h=0){const c=-1!==s?ce[ue(s)]:ce[s],u={name:t,pos:{begin:e,end:e.add(c)},indexDirection:s,cycle:{global:i,self:a,max:l,offset:o,colorOffset:h}};return n&&(u.mirror=n),r&&(u.color=r),u},checkAllConditions:function(t,e){return void 0===e||Object.entries(e).every(([s,n])=>de[s](t,n,e))}};const{getGridSize:pe,getGridOffset:ge,getCanvasOffset:me}=i;function fe(t,e,s){return me(t,e,s)+ge(s)*e}function Ee({c:t,beginPos:e,endPos:s,segmentWidth:n,color:r}){t.beginPath(),t.strokeStyle=r,t.lineWidth=n,t.lineCap="round",t.moveTo(e.x,e.y),t.lineTo(s.x,s.y),t.stroke()}function Se({c:t,pos:e,segmentWidth:s,includeStart:n,color:r}){const i=s+5;t.beginPath(),n?t.fillStyle=r:t.strokeStyle=r,t.lineWidth=2,t.moveTo(e.x,e.y-i),t.lineTo(e.x+i,e.y),t.lineTo(e.x,e.y+i),t.lineTo(e.x-i,e.y),n?t.fill():(t.closePath(),t.stroke())}function Pe({c:t,pos:e,segmentWidth:s,color:n}){t.beginPath(),t.fillStyle=n,t.lineWidth=1,t.arc(e.x,e.y,s+1,0,2*Math.PI),t.fill()}class ve{static createInstance(t){const e=new ve(t);return e._hasCanvasElement()?e._isCanvasSupported()?(e._initContext(),e):(console.error("Canvas is not supported."),null):(console.error("canvas not found: canvasElementId="+t.elements.canvasElementId),null)}constructor({elements:t}){this._initElements(t),this._drawLineCallback=Ee,this._drawStartPathCallback=Se,this._drawEndPathCallback=Pe}_initElements({canvasElementId:t}){this._canvas=document.getElementById(t)}_initContext(){this._c=this._canvas.getContext("2d")}_hasCanvasElement(){return null!==this._canvas}_isCanvasSupported(){return this._canvas.getContext}initParameters({image:t,segment:e}){const{width:s,height:n,margins:r,color:i}=t,{length:a,width:o}=e;this._canvasSize=new ae(s,n),this._imageMargins=r,this._segmentLength=a,this._segmentWidth=o,this._backgroundColor=i}initCanvas(){const{_c:t,_canvasSize:{x:e,y:s},_segmentLength:n,_backgroundColor:r}=this;this._canvas.width=e,this._canvas.height=s,this.gridSize=this.getGridDimension(),this._canvasCenter=new ae(fe(e,n,this.gridSize.x),fe(s,n,this.gridSize.y)),t.fillStyle=r,t.fillRect(0,0,e,s)}setBlur(t){this._canvas.style.filter=`blur(${t}px)`}setDrawLineCallback(t){this._drawLineCallback=t}setDrawStartPathCallback(t){this._drawStartPathCallback=t}setDrawEndPathCallback(t){this._drawEndPathCallback=t}getGridDimension(){const{_canvasSize:t,_imageMargins:e,_segmentLength:s}=this;return new ae(pe(t.x,e,s),pe(t.y,e,s))}drawGrid(t){const{x1:e,x2:s,y1:n,y2:r}=t;for(let i=e;i<=s;i++){const t=0===i?"#bbb":"#ddd";this.drawLine({x:i,y:n},{x:i,y:r},t)}for(let i=n;i<=r;i++){const t=0===i?"#bbb":"#ddd";this.drawLine({x:e,y:i},{x:s,y:i},t)}}drawLine(t,e,s){const{_c:n}=this,r=this.getCanvasPositionFromGrid(t),i=this.getCanvasPositionFromGrid(e);n.beginPath(),n.strokeStyle=s,n.linewidth=1,n.lineCap="butt",n.moveTo(r.x,r.y),n.lineTo(i.x,i.y),n.stroke()}drawGridPath(t,e,s){const n=this.getCanvasPositionFromGrid(t),r=this.getCanvasPositionFromGrid(e);this._drawLineCallback({c:this._c,beginPos:n,endPos:r,segmentWidth:this._segmentWidth,color:s})}drawGridStartPath(t,e,s){const n=this.getCanvasPositionFromGrid(t);this._drawStartPathCallback({c:this._c,pos:n,segmentWidth:this._segmentWidth,includeStart:e,color:s})}drawGridEndPath(t,e){const s=this.getCanvasPositionFromGrid(t);this._drawEndPathCallback({c:this._c,pos:s,segmentWidth:this._segmentWidth,color:e})}getCanvasPositionFromGrid(t){const{_segmentLength:e,_canvasCenter:s}=this;return new ae(t.x*e+s.x,t.y*e+s.y)}}var Ce=ve;const{NO_INDEX_DIRECTION:xe,DIRECTIONS:Ie,isCardinalDirection:be,clampIndexDirection:Te}=_e,{Vector2_ZERO:ye}=oe,{getGridOffset:Re}=i;const{MAX_BOUNDARY:Oe,MIN_BOUNDARY:we,ADD_OPERATOR:Ne,SUB_OPERATOR:Ve,MUL_OPERATOR:Ae,DIV_OPERATOR:Me,MOD_OPERATOR:De}=i;function Le(t,e){const{a:s,op:n,b:r}=e;switch(n){case Ne:return t(s)+t(r);case Ve:return t(s)-t(r);case Ae:return t(s)*t(r);case Me:return t(s)/t(r);case De:return t(s)%t(r);default:throw new Error("unknown operator: "+n)}}const{NO_INDEX_DIRECTION:ke,INITIAL_SELF_CYCLE:Ge,clampIndexDirection:Fe,createInitialStep:$e,createStep:We,checkAllConditions:Be}=_e;var Ue=class{constructor(){this._mapSteps=new Map}init(){this._mapSteps.clear()}get count(){return this._mapSteps.size}getSteps(t){return this._mapSteps.get(t)}forEach(t){this._mapSteps.forEach((e,s)=>{t(e,s)})}addStep(t,e){const s=this._mapSteps.get(t);void 0===s?this._mapSteps.set(t,[e]):s.push(e)}removeSomeSteps(t,e){const s=this._mapSteps.get(t);if(!s)return!1;let n=!1;const r=s.length;for(let a=0;a<r;a++)e.includes(s[a])&&(n=!0,s[a]=void 0);if(!n)return!1;const i=s.filter(t=>void 0!==t);return i.length?(this._mapSteps.set(t,i),!0):this.removeAllSteps(t)}removeAllSteps(t){return this._mapSteps.delete(t)}};const{DIRECTIONS:je,isCardinalDirection:He,clampIndexDirection:Ye}=_e,{constant:Xe}=i;const{NO_INDEX_DIRECTION:ze,DEFAULT_INCLUDE_START_POINT:qe,clampIndexDirection:Ke}=_e;const{STEP_BY_STEP_RUN_TYPE:Ze,ANIMATED_RUN_TYPE:Je,INSTANT_RUN_TYPE:Qe,MAX_ITERATION:ts,DEFAULT_INCLUDE_START_POINT:es,checkAllConditions:ss}=_e;class ns{static createInstance(t){const e=Ce.createInstance(t);return null===e?null:new ns(e)}constructor(t){this._finished=!1,this._runType=Ze,this._stepCallbacks=[],this._finishCallbacks=[],this._spGrid=new class{constructor(t){t&&this.initGrid(t)}initGrid(t){this._gridSize=0!==t.x&&0!==t.y?t:ye;const e=new ae(Re(t.x),Re(t.y));this._gridOffsets=e,this._grid=new Array(t.x*t.y),this._gridRect=new class{constructor(t,e){this.position=t,this.size=e}containsPoint(t){const{x:e,y:s}=this.position,{x:n,y:r}=this.size,{x:i,y:a}=t;return i>=e&&i<e+n&&a>=s&&a<s+r}get x1(){return this.position.x}get x2(){return this.position.x+this.size.x-1}get y1(){return this.position.y}get y2(){return this.position.y+this.size.y-1}}(ye.sub(e),this._gridSize),this._gridLength=this._grid.length}get gridRect(){return this._gridRect}getStrGrid(){const t=[],{_grid:e,_gridSize:s}=this,{x:n,y:r}=s;for(let a=0;a<r;++a){a>0&&t.push("\n");for(let s=0;s<n;++s){s>0&&t.push(" ");const n=e[s*r+a];t.push(void 0===(i=n)?"_":i===xe?"@":i)}}var i;return t.join("")}addIndexDirection(t,e){const{_grid:s}=this;if(this.hasPositionInside(t)){const n=this._getGridPosition(t);if(void 0===s[n])return s[n]=e,!0;console.warn(`Position ${t.toString()} already contains a step.`)}return!1}hasPositionInside(t){return this._gridRect.containsPoint(t)}containsPath(t){return void 0!==this._grid[this._getGridPosition(t)]}hasCrossingPath(t,e){return!be(e)&&(this._hasFoundCrossingPath(t,e,1)||this._hasFoundCrossingPath(t,e,-1))}_hasFoundCrossingPath(t,e,s){const n=t.add(Ie[Te(e+1*s)]);return this._grid[this._getGridPosition(n)]===Te(e-2*s)}_getGridPosition(t){const{x:e,y:s}=t;return(e+this._gridOffsets.x)*this._gridSize.y+s+this._gridOffsets.y}},this._spCanvas=t,this._spManager=new class{constructor(t){this._evaluateStartPath=new class{constructor(t){this._spGrid=t,this._evaluatePosition=new class{constructor(t){this._spGrid=t,this._getXBind=this._getX.bind(this),this._getYBind=this._getY.bind(this),this.init()}init(){this._gridRect=this._spGrid.gridRect}getPosition(t){const{x:e,y:s}=t;return new ae(Number.parseInt(this._getX(e)),Number.parseInt(this._getY(s)))}_getX(t){if("number"==typeof t)return t;if(t===we)return this._gridRect.x1;if(t===Oe)return this._gridRect.x2;if("object"==typeof t)return Le(this._getXBind,t);throw new Error("invalid type: "+typeof t)}_getY(t){if("number"==typeof t)return t;if(t===we)return this._gridRect.y1;if(t===Oe)return this._gridRect.y2;if("object"==typeof t)return Le(this._getYBind,t);throw new Error("invalid type: "+typeof t)}}(t)}init(){this._evaluatePosition.init()}eval(t){return this._startPaths=t,this._evaluateStartPathsPosition(),this._filterStartPaths(),this._startPaths}_evaluateStartPathsPosition(){this._startPaths.forEach(t=>{t.startPos=this._evaluatePosition.getPosition(t.startPos)})}_filterStartPaths(){const t=this._spGrid.hasPositionInside.bind(this._spGrid);this._startPaths=this._startPaths.filter(({startPos:e})=>t(e))}}(t),this._nextStepGenerator=new class{constructor(){}setPaths(t){this._paths=t}getStartSteps(t){const e=this._paths;return t.flatMap(({startPos:t,paths:s,props:n={}})=>{const{color:r,maxCycle:i,offsetCycle:a=0}=n;return s.flatMap(({name:s,indexDirection:n,mirror:o,color:l,offsetCycle:h})=>{let c;if(void 0!==l)c=l;else if(void 0!==r)c=r;else{const t=e[s];t&&t.props&&t.props.color&&(c=t.props.color)}return $e(s,t,n,o,c,void 0!==h?h:a,i)})})}getNextSteps(t){const{cycle:{self:e,offset:s}}=t;return e+s<0?[this._getStraightNextStep(t)]:this._getNextStepsOfPath(t)}_getStraightNextStep(t){const{name:e,pos:{end:s},indexDirection:n,mirror:r,color:i,cycle:{global:a,self:o,max:l,offset:h,colorOffset:c}}=t;return We(e,s,n,r,i,a+1,o+1,h,l,c)}_getNextStepsOfPath(t){const{name:e,cycle:{self:s,offset:n}}=t,r=this._paths[e];if(void 0===r)return[this._createEndStep(t)];const{nextSteps:i,props:a}=r,o=i.find(({conditions:t})=>Be(s+n+1,t));return void 0===o?[this._createEndStep(t)]:o.directions.map(e=>this._getNextStepOfPath(e,t,a))}_getNextStepOfPath(t,e,s={}){const n=function(t,e,s){return void 0!==e.color?e.color:void 0!==t.color?t.color:s.color}(e,t,s);return We(function(t,e){return void 0!==e.pathName?e.pathName:t.name}(e,t),function(t){return t.pos.end}(e),function(t,e){const{indexDirection:s,mirror:n}=t,{turn:r}=e;return null!==r?Fe(s+(n?-r:r)):ke}(e,t),function(t,e){return!!(t.mirror^e.mirror)||void 0}(e,t),n,function(t){return t.cycle.global+1}(e),function(t,e){return void 0===e.pathName?t.cycle.self+1:Ge}(e,t),function(t,e){const{pathName:s,offset:n=0}=e;return void 0!==s?n:t.cycle.offset}(e,t),function(t,e){const{cycle:{max:s}}=t,{maxCycle:n}=e;return void 0!==s&&void 0!==n?Math.min(s,n):void 0!==s?s:n}(e,s),function(t,e){const{color:s,cycle:{self:n,colorOffset:r}}=t;return s!==e?n+1:r}(e,n))}_createEndStep(t){const{pos:{end:e},mirror:s,color:n,cycle:{global:r,self:i,max:a,offset:o,colorOffset:l}}=t;return We(null,e,ke,s,n,r+1,i+1,o,a,l)}},this._initStepManagers(),this._invalidPathRemover=new class{constructor(t){this._invalidPathFinder=new class{constructor({spGrid:t}){this._spGrid=t,this._lastCycle=Number.MAX_SAFE_INTEGER}set spGrid(t){this._spGrid=t}set stepManager(t){this._stepManager=t}set lastCycle(t){this._lastCycle=""!==t?t:Number.MAX_SAFE_INTEGER}findInvalidSteps(){const{_spGrid:t}=this;return this._findSteps(e=>{const{name:s,pos:{end:n}}=e;return null===s||!t.hasPositionInside(n)||t.containsPath(n)})}findEndOfCycleSteps(){return this._findSteps(t=>{const{cycle:{global:e,max:s,self:n}}=t;return n>s||e>this._lastCycle})}findCrossingExistingDiagonalSteps(){const{_spGrid:t}=this;return this._findSteps(e=>{const{pos:{begin:s},indexDirection:n}=e;return s&&t.hasCrossingPath(s,n)})}findCollisionSteps(){return this._findSteps(t=>{const{pos:{begin:e},indexDirection:s}=t,n=this._stepManager.getSteps(e.toString());return void 0!==n?n.some(t=>t.indexDirection===Ye(s+4)):void 0})}findCrossingOngoingDiagonalsSteps(){const t=this._hasCrossingOngoingStep.bind(this);return this._findSteps(e=>e.pos.begin&&t(e))}_hasCrossingOngoingStep(t){const{pos:{end:e},indexDirection:s}=t;return function(t,e){return He(e)?[]:[-1,1].map(s=>function(t,e,s){const n=e+3*s;return{endPos:t.add(je[Ye(n)]),dir:Ye(e+2*s)}}(t,e,s))}(e,s).some(({endPos:t,dir:e})=>{const s=this._stepManager.getSteps(t.toString());return void 0!==s?s.some(t=>t.indexDirection===e):void 0})}findSameDestinationOngoingSteps(){return this._findSteps(Xe(!0),t=>t.length>1)}_findSteps(t,e=Xe(!0)){const s=[];return this._stepManager.forEach(n=>{e(n)&&n.filter(t).forEach(t=>s.push(t))}),s}}({spGrid:t}),this._endPathManager=new class{constructor(){this._beginSegmentPosOfNextStep=new Map,this._endPathsPos=new Set}init(){this._beginSegmentPosOfNextStep.clear(),this._endPathsPos.clear()}get count(){return this._endPathsPos.size}addCountFromSteps(t){const e=this._addCountFromStep.bind(this);t.filter(t=>t.pos.begin).forEach(t=>{e(t)})}_addCountFromStep(t){const{pos:{begin:e}}=t,s=e.toString(),{_beginSegmentPosOfNextStep:n}=this,r=n.get(s);r?++r.count:n.set(s,{count:1})}removeCountFromSteps(t){const e=this.removeCountFromStep.bind(this);return t.reduce((t,s)=>e(s)||t,!1)}removeCountFromStep(t){const{pos:{begin:e}}=t,{_beginSegmentPosOfNextStep:s}=this,n=e.toString(),r=s.get(n);return!!r&&(--r.count,0===r.count&&(s.delete(n),this._endPathsPos.add(t)),!0)}forEach(t){return this._endPathsPos.forEach(e=>t(e))}},this._includeEnd=!1}init(){this._endPathManager.init()}get includeEnd(){return this._includeEnd}set includeEnd(t){this._includeEnd=t}set lastCycle(t){this._invalidPathFinder.lastCycle=t}get endPathCount(){return this._endPathManager.count}removeInvalidNextSteps(t){const e=new Set,s=this._removeSomeSteps.bind(this);this._nextSteps=t,this._invalidPathFinder.stepManager=t,this._includeEnd&&t.forEach(t=>this._endPathManager.addCountFromSteps(t)),this._invalidPathFinder.findInvalidSteps().forEach(s),this._invalidPathFinder.findEndOfCycleSteps().forEach(s),this._invalidPathFinder.findCrossingExistingDiagonalSteps().forEach(s),this._invalidPathFinder.findCollisionSteps().forEach(t=>e.add(t)),this._invalidPathFinder.findCrossingOngoingDiagonalsSteps().forEach(t=>e.add(t)),this._invalidPathFinder.findSameDestinationOngoingSteps().forEach(t=>e.add(t)),e.forEach(s)}_removeSomeSteps(t){const e=[t];this._nextSteps.removeSomeSteps(t.pos.end.toString(),e),this._includeEnd&&this._endPathManager.removeCountFromSteps(e)}forEachEndPaths(t){this._endPathManager.forEach(t)}}(t),this._spGrid=t,this._startPaths=[],this._currentCycle=0,this._totalSegmentCount=0,this._totalEndPathCount=0}_initStepManagers(){this._spManagers=[],this._spManagerIndex=0;for(let t=0;t<2;++t)this._spManagers.push(new Ue);this._swapSteps()}init(){this._evaluateStartPath.init(),this._clearStepManagers(),this._invalidPathRemover.init(),this._paths=void 0,this._startPaths=void 0,this._currentCycle=0,this._totalSegmentCount=0,this._totalEndPathCount=0}initParameters({segmentCount:t,includeEnd:e,showEnd:s,lastCycle:n}){this._segmentCount=t,this._includeEnd=e,this._showEnd=s,this._invalidPathRemover.includeEnd=e||s,this._invalidPathRemover.lastCycle=n}_clearStepManagers(){this._spManagerIndex=0;for(let t=0;t<2;++t)this._spManagers[t].init();this._swapSteps()}get cycleAndCounts(){const t={cycle:this._currentCycle};return this._segmentCount&&(t.segmentCount=this._totalSegmentCount),this._includeEnd&&(t.endPathCount=this._totalEndPathCount),t}getCurrentStep(t){return this._currentSteps.getSteps(t)[0]}setPaths(t){this._paths=t,this._nextStepGenerator.setPaths(t)}prepareInitialStep(t){this._startPaths=t,this._addInitialSteps(),this._addInitialIndexDirection(),this._checkNextSteps()}_addInitialSteps(){const t=this._evaluateStartPath.eval(this._startPaths);this._nextStepGenerator.getStartSteps(t).forEach(t=>this._nextSteps.addStep(t.pos.end.toString(),t))}_addInitialIndexDirection(){const{_spGrid:t}=this;this._startPaths.forEach(({startPos:e,props:s={}})=>{const{includeStartPoint:n=qe}=s;!t.containsPath(e)&&n&&t.addIndexDirection(e,ze)})}step(){return this._currentCycle++,this._spManagerIndex++,this._swapSteps(),this._initSteps(),this._updateGrid(),this._addPotentialNextSteps(),this._checkNextSteps(),this.hasNextStep()}iterateStartSteps(t){this._startPaths.forEach(t)}iterateCurrentSteps(t){this._currentSteps.forEach(t)}iterateEndPaths(t){this._invalidPathRemover.forEachEndPaths(t)}_updateGrid(){const{_spGrid:t}=this;this._currentSteps.forEach((e,s)=>{e.length>1&&console.warning(`position (${s}) contain more than one step.`);const n=e[0];t.addIndexDirection(n.pos.end,Ke(n.indexDirection+4))}),this._totalSegmentCount+=this._currentSteps.count}_swapSteps(){this._currentSteps=this._spManagers[(this._spManagerIndex+0)%2],this._nextSteps=this._spManagers[(this._spManagerIndex+1)%2]}_initSteps(){this._nextSteps.init(),this._invalidPathRemover.init()}_addPotentialNextSteps(){this._currentSteps.forEach((t,e)=>{t.length>1?console.warn(`current path at ${e} contains more than one step`):this._nextStepGenerator.getNextSteps(t[0]).map(t=>{this._nextSteps.addStep(t.pos.end.toString(),t)})})}_checkNextSteps(){this._invalidPathRemover.removeInvalidNextSteps(this._nextSteps),this._totalEndPathCount+=this._invalidPathRemover.endPathCount}hasNextStep(){return this._nextSteps.count>0}}(this._spGrid),this._animation=new class{constructor(){this._runAnimationIntervalId=null,this._animationCallbacks=[],this._isOngoing=!1}initParameters({delayInMs:t}){this._delayInMs=t}addAnimationListener(t){this._animationCallbacks.push(t)}set isOngoing(t){this._isOngoing=t}start(){const{_animationCallbacks:t}=this;this.stop(),this._runAnimationIntervalId=setInterval(()=>{this._isOngoing||t.forEach(t=>{t()})},this._delayInMs)}stop(){null!==this._runAnimationIntervalId&&(clearInterval(this._runAnimationIntervalId),this._runAnimationIntervalId=null)}},this._animation.addAnimationListener(this.step.bind(this))}initParameters(t,{image:e,segment:s,path:{segmentCount:n,includeEnd:r,showStart:i,showEnd:a},grid:{showGrid:o},cycle:{start:l,last:h},animation:c}){this._runType=t,this._pathShowStart=i,this._pathShowEnd=a,this._showGrid=o,this._startCycle=l,this._lastCycle=h,this._delayInMs=delayInMs,this._defaultSegmentColor=s.color,this._animation.initParameters(c),this._initCanvas(e,s),this._spManager.initParameters({segmentCount:n,includeEnd:r,showEnd:a,lastCycle:h})}setBlur(t){this._spCanvas.setBlur(t)}_initCanvas(t,e){this._spCanvas.initParameters({image:t,segment:e}),this._spCanvas.initCanvas(),this._spGrid.initGrid(this._spCanvas.getGridDimension())}initData({paths:t,startPaths:e,colors:s}){return this._spManager.init(),this._spManager.setPaths(t),this._spManager.prepareInitialStep(e),this._colors=s,!0}startDrawGrid(t,e){this._initCanvas(t,e),this.drawGrid()}drawGrid(){this._spCanvas.drawGrid(this._spGrid.gridRect)}applyRun(t){this._runType=t,this._runAnimated(),this._runType===Qe&&this._runSteps()}run(){this._animation.stop(),this._finished=!1,this._initialStep(),this._spManager.iterateStartSteps(this._drawStartPath.bind(this)),this._runSteps(this._startCycle),this._finished||(this._runType===Qe?this._runSteps():this._runType===Je&&this._animation.start())}_runAnimated(){this._finished||(this._runType===Je?this._animation.start():this._animation.stop())}_runSteps(t=ts){let e=0;for(;e<t&&this.step();)++e}_initialStep(){this._stepCallbacks.forEach(t=>t(this._spManager.cycleAndCounts)),this._showGrid&&this.drawGrid()}step(){if(this._finished)return!1;this._animation.isOngoing=!0;const t=this._spManager.step();return this._spManager.iterateCurrentSteps(this._drawStep.bind(this)),this._pathShowEnd&&this._spManager.iterateEndPaths(this._drawEndPath.bind(this)),this._stepCallbacks.forEach(t=>t(this._spManager.cycleAndCounts)),t||this._finish(),this._animation.isOngoing=!1,t}_drawStartPath(t){if(this._pathShowStart){const{startPos:e,paths:s,props:n={}}=t,{color:r,includeStartPoint:i=es}=n;let a=this._getStartStepColor(r,s);this._spCanvas.drawGridStartPath(e,i,a)}}_drawStep(t){const[e]=t,{pos:{begin:s,end:n}}=e;void 0!==s&&this._spCanvas.drawGridPath(s,n,this._getStepColor(e))}_drawEndPath(t){const{pos:{begin:e}}=t,s=this._spManager.getCurrentStep(e.toString());this._spCanvas.drawGridEndPath(e,this._getStepColor(s))}_getStartStepColor(t,e){const s=e.find(({color:t})=>void 0!==t);let n=this._getColor(t);return n||(n=this._getColor(s&&s.color?s.color:void 0)),void 0!==n?n:this._defaultSegmentColor}_getStepColor(t){const{color:e,cycle:{self:s,colorOffset:n}}=t,r=this._getColor(e,s-n+1,s);return void 0!==r?r:this._defaultSegmentColor}_getColor(t,e=1,s=0){if(!t)return;const n=this._colors[t];if(void 0!==n){const{list:t,next:r}=n;if(r){const t=r.find(({conditions:t})=>ss(e,t));if(t)return t.color}const i=t&&t.length?t.length:0;return i?t[s%i]:void 0}return t}_finish(){this._finished=!0,this._animation.stop(),this._finishCallbacks.forEach(t=>t())}onStep(t){this._stepCallbacks.push(t)}onFinish(t){this._finishCallbacks.push(t)}}var rs=ns,is={initLoadFile:function({fileInputId:t="inputFile",callback:e}){const s=new FileReader;s.onload=()=>{e(s.result)};const n=document.getElementById(t);return n.addEventListener("change",(function(t){s.readAsText(t.target.files[0])})),{loadFile:function(){n.click()}}},saveFile:function({data:t,type:e="text/plain",filename:s}){const n=new Blob(t,{type:e}),r=document.createElement("a"),i=URL.createObjectURL(n);r.href=i,r.download=s,document.body.appendChild(r),r.click(),setTimeout((function(){document.body.removeChild(r),window.URL.revokeObjectURL(i)}))}};const{STEP_BY_STEP_RUN_TYPE:as,ANIMATED_RUN_TYPE:os,DEFAULT_COLOR:ls}=_e,{initLoadFile:hs,saveFile:cs}=is;window.onload=function(){function t(t){return CSS.supports("color",t)}const r=rs.createInstance({elements:{canvasElementId:"image"}});if(null===r)return void console.error("error: failed to create SplitPathDrawer instance.");const i=new re({colorValidator:t}),a=new class{constructor({colorValidator:t}={}){this._colorValidator=t,this._errors=[],this._warnings=[]}init(){this._errors=[],this._warnings=[]}hasError(){return this._errors.length>0}hasWarning(){return this._warnings.length>0}getErrors(){return this._errors}getWarnings(){return this._warnings}getErrorMessages(){return this._errors.join("\n")}getWarningMessages(){return this._warnings.join("\n")}format({paths:t,startPaths:e,colors:s}){if(this.init(),this._paths=t,this._startPaths=e,this._colors=s,this._hasColorAndPathNamesCollision())return!1;if(!this._formatPaths())return!1;const n=this._checkPaths(),r=this._checkStartPaths();return n&&r}_hasColorAndPathNamesCollision(){const{_errors:t}=this,e=new Set(Object.keys(this._colors));return Object.keys(this._paths).some(s=>{const n=e.has(s);return n&&t.push("cannot declare path and color with the same name: "+s),n})}_formatPaths(){let t=!0;const{_errors:e}=this;return Object.values(this._paths).forEach(({nextSteps:s})=>{s.forEach(({directions:s})=>{s.forEach(s=>{const{pathName:n,color:r,offset:i}=s;void 0!==n?void 0===r&&!this._hasPath(n)&&this._hasColor(n)?(s.color=n,delete s.pathName):void 0!==r&&this._hasColor(n)&&this._hasColor(r)&&(t=!1,e.push(`cannot set two colors inside path: ${n}, ${r}`)):void 0!==i&&(t=!1,e.push("path name is required if offset is present"))})})}),t}_checkPaths(){const{_errors:t}=this;let e=!1,s=!1;return Object.values(this._paths).forEach(({nextSteps:n})=>{n.forEach(({directions:n})=>{n.filter(({pathName:t})=>!this._hasPath(t,!0)).forEach(({pathName:s})=>{e=!0,t.push("cannot find next path: "+s)}),n.filter(({color:t})=>!this._hasColor(t)).forEach(({color:e})=>{s=!0,t.push("cannot find next color: "+e)})})}),!e&&!s}_checkStartPaths(){const{_errors:t}=this;let e=!1,s=!1;return this._startPaths.forEach(({paths:n})=>{n.filter(({name:t})=>!this._hasPath(t)).forEach(({name:s})=>{e=!0,t.push("cannot find start path: "+s)}),n.filter(({color:t})=>!this._hasColor(t)).forEach(({color:e})=>{s=!0,t.push("cannot find start color: "+e)})}),!e&&!s}_hasPath(t,e){return void 0===t&&e||void 0!==this._paths[t]}_hasColor(t){return void 0===t||void 0!==this._colors[t]||!this._colorValidator||this._colorValidator(t)}}({colorValidator:t}),o={fields:{image:{width:{type:"number",elementId:"imageWidth",minValue:2,maxValue:5e3,defaultValue:300,save:!0},height:{type:"number",elementId:"imageHeight",minValue:2,maxValue:5e3,defaultValue:300,save:!0},margins:{type:"number",elementId:"imageMargins",minValue:0,defaultValue:10,save:!0},color:{type:"text",elementId:"backgroundColorText",defaultValue:"white",save:!0}},grid:{showGrid:{type:"checkbox",elementId:"gridShowGrid",defaultValue:!0},width:{type:"label",elementId:"gridWidth"},height:{type:"label",elementId:"gridHeight"}},segment:{length:{type:"number",elementId:"segmentLength",defaultValue:22,minValue:1,save:!0},width:{type:"number",elementId:"segmentWidth",defaultValue:4,minValue:1,save:!0},color:{type:"text",elementId:"segmentColorText",defaultValue:ls,save:!0}},path:{segmentCount:{type:"checkbox",elementId:"pathSegmentCount",defaultValue:!0},showStart:{type:"checkbox",elementId:"pathShowStart",defaultValue:!0},includeEnd:{type:"checkbox",elementId:"pathIncludeEnd",defaultValue:!0},showEnd:{type:"checkbox",elementId:"pathShowEnd",defaultValue:!0}},cycle:{start:{type:"number",elementId:"startCycle",defaultValue:"",minValue:1,numberRequired:!1,save:!0},last:{type:"number",elementId:"lastCycle",defaultValue:"",minValue:1,numberRequired:!1,save:!0}},animation:{delayInMs:{type:"number",elementId:"delayInMs",defaultValue:50}}}};!function(t){new u({elementId:"imageBlur",minValue:0,maxValue:20,defaultValue:0}).onInput(e=>{t.setBlur(e)})}(r);const{pathsScriptTextArea:l,errorMessagesTextArea:h}={pathsScriptTextArea:new m({elementId:"pathsScript"}),errorMessagesTextArea:new m({elementId:"errorMessages"})},{parameters:f}=function(t){const e=new class extends class{constructor({fields:t}){this._initElements(t),this._initEventListeners()}_initElements(t){this._fields={},Object.entries(t).forEach(([t,e])=>{const s={};Object.entries(e).forEach(([t,e])=>{s[t]=this._createField(e)}),this._fields[t]=s})}_createField(t){const{type:e,save:s}=t;if("number"===e)return{input:new c(t),getValue(){return this.input.getIntValue()},setValue(t){this.input.setValue(t)},restore(){this.input.restoreDefaultValue()},save:s};if("label"===e)return{input:new n(t)};if("checkbox"===e)return{input:new _(t),getValue(){return this.input.getBoolValue()},setValue(t){this.input.setValue(t)},restore(){this.input.restoreDefaultValue()},save:s};if("range"===e)return{input:new u(t),getValue(){return this.input.getIntValue()},setValue(t){this.input.setValue(t)},restore(){this.input.restoreDefaultValue()},save:s};if("text"===e)return{input:new p(t),getValue(){return this.input.getTextValue()},setValue(t){this.input.setValue(t)},restore(){this.input.restoreDefaultValue()},save:s};throw new Error("input type not found: "+e)}_initEventListeners(){}getValues({onlySave:t=!1}={}){const e={};for(const[s,n]of Object.entries(this._fields)){const r={};let i=!1;for(const[e,s]of Object.entries(n))t&&!s.save||!s.getValue||(i=!0,r[e]=s.getValue());i&&(e[s]=r)}return e}setValues(t,{onlySave:e=!1}={}){Object.entries(t).forEach(([t,s])=>{Object.entries(s).forEach(([s,n])=>{const r=this._fields[t][s];e&&!r.save||r.setValue(n)})})}restoreDefaultValues(){for(const t of Object.values(this._fields))for(const e of Object.values(t))e.restore&&e.restore()}}{constructor(t){super(t),this._updateGridWidth(),this._updateGridHeight(),this._fields.grid.width.restore=()=>{this._updateGridWidth()},this._fields.grid.height.restore=()=>{this._updateGridHeight()}}_initEventListeners(){super._initEventListeners();const{_fields:t}=this;t.image.width.input.onChange(this._updateGridWidth.bind(this)),t.image.height.input.onChange(this._updateGridHeight.bind(this)),t.image.margins.input.onChange(()=>{this._updateGridWidth(),this._updateGridHeight()}),t.segment.length.input.onChange(()=>{this._updateGridWidth(),this._updateGridHeight()}),t.cycle.start.input.onChange(this.adjustLastCycle.bind(this)),t.cycle.last.input.onChange(this.adjustStartCycle.bind(this)),this.adjustLastCycle(),t.animation.delayInMs.input.onChange(this.adjustDelayInMs.bind(this))}_updateGridWidth(){this._fields.grid.width.input.setText(this.getGridWidth())}_updateGridHeight(){this._fields.grid.height.input.setText(this.getGridHeight())}adjustStartCycle(){const t=this.getStartCycle(),e=this.getLastCycle();""!==t&&""!==e&&t>e&&this._fields.cycle.start.input.setValue(e)}adjustLastCycle(){const t=this.getStartCycle(),e=this.getLastCycle();""!==t&&""!==e&&e<t&&this._fields.cycle.last.input.setValue(t)}adjustDelayInMs(){this.getDelayInMs()<1&&this._fields.animation.delayInMs.input.setValue(1)}getImageWidth(){return this._fields.image.width.input.getIntValue()}getImageHeight(){return this._fields.image.height.input.getIntValue()}getImageMargins(){return this._fields.image.margins.input.getIntValue()}getSegmentLength(){return this._fields.segment.length.input.getIntValue()}getStartCycle(){return this._fields.cycle.start.input.getIntValue()}getLastCycle(){return this._fields.cycle.last.input.getIntValue()}getDelayInMs(){return this._fields.animation.delayInMs.input.getIntValue()}getGridWidth(){const t=this.getImageWidth(),e=this.getImageMargins(),s=this.getSegmentLength();return g(t,e,s)}getGridHeight(){const t=this.getImageHeight(),e=this.getImageMargins(),s=this.getSegmentLength();return g(t,e,s)}restoreDefaultValues(){super.restoreDefaultValues(),this._updateGridWidth(),this._updateGridHeight()}}(t);return new s({elementId:"restoreParameters"}).onClick(()=>{e.restoreDefaultValues()}),{parameters:e}}(o),{currentCycleLabel:E,segmentCountLabel:S,endPathCountLabel:P}={currentCycleLabel:new n({elementId:"currentCycle"}),segmentCountLabel:new n({elementId:"segmentCount"}),endPathCountLabel:new n({elementId:"endPathCount"})};!function(t,n){const r=/^\[script\]\n(.+)\n\[parameters\]\n(.+?)$/s,i=new s({elementId:"loadScript"}),a=new s({elementId:"saveScript"}),{loadFile:o}=hs({fileInputId:"fileScript",callback:s=>{const i=r.exec(s);if(null!==i)try{const[,e,s]=i,r=JSON.parse(s);t.setValues(r,{onlySave:!0}),n.setValue(e)}catch(e){console.error(e),alert("Invalid parameters format")}else alert("Invalid file content format")}});i.onClick(()=>{o()}),a.onClick(()=>{const e=["[script]\n",n.getRawValue(),"\n[parameters]\n",JSON.stringify(t.getValues({onlySave:!0}),null,4)];cs({data:e,filename:"sp-script.txt"})})}(f,l),function(){const t=document.getElementById("modalHelp"),e=document.getElementById("openModalHelp"),s=document.getElementById("closeModalHelp");e.addEventListener("click",()=>{t.classList.remove("hidden")}),s.addEventListener("click",()=>{t.classList.add("hidden")})}();const{moveOneStepButton:v,moveNStepButton:C,runRadioButtons:x}=function(t,e,n,r){new s({elementId:"runButton"}).onClick(()=>{b(!1),I(t,e,n,r,h)});const i=new s({elementId:"moveOneStep"});i.onClick(()=>{h.select(as),t.step()});const a=new s({elementId:"moveNStep"});a.onClick(()=>{h.select(as);const e=l.getIntValue();let s=0;for(;s<e&&t.step();)++s});const o=new d({elementId:"moveNStepText"}),l=new c({elementId:"moveNStepQuantity",defaultValue:5,minValue:2});l.onChange(u);const h=new class{constructor({elementsId:t,name:e}){this._elements=[],this._callbacksOnClick=[],this._name=e,t.forEach(t=>{const e=document.getElementById(t);this._elements.push(e)}),this._initEventListeners()}_initEventListeners(){this._elements.forEach(t=>{t.addEventListener("click",this._eventClick.bind(this))})}_eventClick(t){const{value:e}=t.target;this._callbacksOnClick.forEach(t=>t(e))}getValue(){const t=this._elements.find(t=>t.checked);return t&&t.value?t.value:null}select(t){this._elements.filter(e=>e.value===t).forEach(t=>t.click())}onClick(t){this._callbacksOnClick.push(t)}}({elementsId:["stepByStepRunType","animatedRunType","instantRunType"],name:"runType"});function u(){const t=l.getIntValue();a.setTitle(function(t){return`Move ${t} steps`}(t)),o.setText(t)}return h.onClick(e=>{t.applyRun(e)}),u(),{moveOneStepButton:i,moveNStepButton:a,runRadioButtons:h}}(r,f,l,h);function I(t,e,s,n,r){const o=e.getValues();if(t.initParameters(r.getValue(),o),i.init(),i.parse(s.getValue()),n.clearValue(),i.hasWarning()&&n.appendText(i.getWarningMessages()+"\n"),i.hasError())return void n.appendText(i.getErrorMessages()+"\n");const l=i.getResult();a.format(l),a.hasWarning()&&n.appendText(a.getWarningMessages()+"\n"),a.format(l)?(t.initData(l),t.run()):n.appendText(a.getErrorMessages()+"\n")}function b(t){v.setDisabled(t),C.setDisabled(t)}!function(t,e){const s=e.getValues(),{image:n,segment:r}=s;t.startDrawGrid(n,r)}(r,f),r.onStep(({cycle:t,segmentCount:e,endPathCount:s})=>{E.setText(function(t){return"Cycle "+t}(t)),S.setText(function(t){return void 0!==t?"Segment count: "+t.toLocaleString("en-US"):""}(e)),P.setText(function(t){return void 0!==t?"End path count: "+t.toLocaleString("en-US"):""}(s))}),r.onFinish(()=>{b(!0)}),function(t,e,s,n,r){b(!1),r.select(os),I(t,e,s,n,r)}(r,f,l,h,x)}}();